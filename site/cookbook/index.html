<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALE Psych Engine Cookbook</title>
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/icons/cookbook/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/icons/cookbook/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="../assets/icons/cookbook/favicon-16.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="../assets/icons/cookbook/favicon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="../assets/icons/cookbook/favicon-512.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #131119;
      --surface: #1b1822;
      --surface-strong: #23202b;
      --text: #f5f2fa;
      --muted: #c9c2d7;
      --border: #332e40;
      --accent: #f28b3c;
      --accent-soft: rgba(242, 139, 60, 0.15);
      --accent-2: #8a6cff;
      --accent-2-soft: rgba(138, 108, 255, 0.16);
      --shadow: rgba(9, 7, 14, 0.35);
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a {
      color: var(--accent);
    }

    a:focus-visible,
    button:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--accent-2);
      outline-offset: 2px;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 30;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 10px 24px var(--shadow);
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .brand-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--surface-strong);
      border: 1px solid var(--border);
      display: grid;
      place-items: center;
    }

    .brand-icon img {
      width: 22px;
      height: 22px;
      display: block;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .brand-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .page-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      min-width: 0;
    }

    .page-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    .page-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .breadcrumbs {
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-toggle {
      display: none;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .search {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 220px;
    }

    .search input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface-strong);
      color: var(--text);
    }

    .language-switch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface-strong);
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
    }

    .language-switch select {
      background: transparent;
      color: var(--text);
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
    }

    .language-switch option {
      color: #1c120a;
    }

    .header-home {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      color: var(--text);
      text-decoration: none;
      background: var(--surface-strong);
      font-size: 13px;
      font-weight: 600;
    }

    .edit-page {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      color: var(--text);
      text-decoration: none;
      background: transparent;
      font-size: 12px;
      font-weight: 600;
    }

    .edit-page:hover,
    .edit-page:focus-visible {
      border-color: var(--accent);
      color: var(--accent);
    }

    .header-home:hover,
    .header-home:focus-visible {
      border-color: var(--accent-2);
    }

    #layout {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr) 220px;
      gap: 0;
      min-height: calc(100vh - 64px);
    }

    #nav-drawer {
      padding: 16px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      position: relative;
    }

    main {
      padding: 28px 32px 48px;
      overflow: hidden;
    }

    .category {
      margin-bottom: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface-strong);
    }

    .category summary {
      cursor: pointer;
      list-style: none;
      padding: 10px 12px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .category summary::-webkit-details-marker {
      display: none;
    }

    .category ul {
      list-style: none;
      margin: 0;
      padding: 6px 0;
    }

    .category li {
      margin: 0;
    }

    .doc-link {
      display: block;
      padding: 8px 12px;
      color: var(--muted);
      text-decoration: none;
      border-left: 2px solid transparent;
    }

    .doc-link:hover,
    .doc-link:focus {
      color: var(--text);
      background: var(--accent-2-soft);
    }

    .doc-link.active {
      color: var(--text);
      border-left-color: var(--accent);
      background: var(--accent-soft);
    }

    .content {
      max-width: 820px;
      margin: 0 auto;
      line-height: 1.7;
    }

    #giscus-container {
      max-width: 820px;
      margin: 32px auto 0;
    }

    .content h1 {
      margin-top: 0;
      font-size: 32px;
      color: var(--text);
    }

    .content h2 {
      margin-top: 24px;
      font-size: 22px;
      color: var(--accent);
    }

    .content h3 {
      margin-top: 20px;
      font-size: 18px;
      color: var(--accent-2);
    }

    .content p,
    .content li {
      color: var(--muted);
      line-height: 1.6;
    }

    .content ul {
      padding-left: 20px;
    }

    .content ol {
      padding-left: 24px;
    }

    .content hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 24px 0;
    }

    .content a {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px solid rgba(242, 139, 60, 0.35);
    }

    .content a:hover,
    .content a:focus-visible {
      color: var(--accent-2);
      border-bottom-color: rgba(138, 108, 255, 0.5);
    }

    .content img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 18px auto;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .content blockquote {
      margin: 16px 0;
      padding: 12px 16px;
      border-left: 3px solid var(--accent-2);
      background: var(--surface-strong);
      color: var(--muted);
      border-radius: 8px;
    }

    .content pre {
      background: var(--surface-strong);
      padding: 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow-x: auto;
    }

    .content code {
      font-family: "Consolas", "SFMono-Regular", monospace;
      color: var(--text);
    }

    .content :not(pre) > code {
      background: var(--accent-soft);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(242, 139, 60, 0.3);
    }

    .content table {
      width: 100%;
      border-collapse: collapse;
      margin: 18px 0;
      color: var(--muted);
    }

    .content th,
    .content td {
      border: 1px solid var(--border);
      padding: 8px 10px;
      text-align: left;
    }

    .content thead th {
      background: var(--surface-strong);
      color: var(--text);
    }

    .related-pages {
      margin-top: 24px;
      padding: 16px;
      border-radius: var(--radius);
      background: var(--surface-strong);
      border: 1px solid var(--border);
    }

    .related-pages h2 {
      margin-top: 0;
      color: var(--accent-2);
    }

    #toc {
      padding: 20px 16px;
      border-left: 1px solid var(--border);
      background: var(--surface);
    }

    #toc.is-empty {
      display: none;
    }

    .toc-inner {
      position: sticky;
      top: 88px;
    }

    .toc-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .toc-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
      font-size: 14px;
    }

    .toc-list a {
      color: var(--muted);
      text-decoration: none;
    }

    .toc-list a:hover,
    .toc-list a:focus-visible {
      color: var(--accent);
    }

    .toc-list .toc-h3 {
      padding-left: 12px;
      font-size: 13px;
    }

    .wip-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 12px 20px;
      background: #2a2436;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-size: 14px;
    }

    .wip-banner p {
      margin: 0;
      color: var(--muted);
    }

    .wip-banner strong {
      color: var(--accent);
    }

    .wip-banner button {
      border: 1px solid var(--border);
      background: var(--surface-strong);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }

    .wip-banner button:hover,
    .wip-banner button:focus-visible {
      border-color: var(--accent-2);
    }

    .site-footer {
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      background: var(--surface);
      color: var(--muted);
      font-size: 13px;
      display: flex;
      justify-content: center;
    }

    .site-footer button {
      border: none;
      background: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 13px;
    }

    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 8, 14, 0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 20;
    }

    .nav-open .drawer-overlay {
      opacity: 1;
      pointer-events: auto;
    }

    @media (max-width: 1200px) {
      #layout {
        grid-template-columns: 240px minmax(0, 1fr);
      }

      #toc {
        display: none;
      }
    }

    @media (max-width: 900px) {
      .nav-toggle {
        display: inline-flex;
      }

      .wip-banner {
        flex-direction: column;
        align-items: flex-start;
      }

      .topbar {
        padding: 12px 16px;
        flex-wrap: wrap;
      }

      .search {
        min-width: 0;
      }

      #layout {
        grid-template-columns: 1fr;
      }

      #nav-drawer {
        position: fixed;
        top: 64px;
        bottom: 0;
        left: 0;
        width: min(80vw, 320px);
        transform: translateX(-100%);
        transition: transform 0.2s ease;
        z-index: 25;
      }

      .nav-open #nav-drawer {
        transform: translateX(0);
      }

      main {
        padding: 24px 18px 36px;
      }

      .topbar-actions {
        gap: 8px;
      }

      .page-meta {
        order: 3;
        flex-basis: 100%;
      }

      .page-actions {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <button class="nav-toggle" id="nav-toggle" type="button" aria-label="Toggle navigation" aria-controls="nav-drawer" aria-expanded="false">
          Menu
        </button>
        <div class="brand-icon">
          <img src="../assets/icons/cookbook/favicon-512.png" alt="Cookbook icon" />
        </div>
        <div class="brand-text">
          <div class="brand-title" id="site-title">ALE Psych Engine Cookbook</div>
          <div class="breadcrumbs" id="breadcrumbs"></div>
        </div>
      </div>
      <div class="page-meta">
        <div class="page-title" id="page-title">Loading</div>
        <div class="breadcrumbs" id="page-subtitle"></div>
        <div class="page-actions">
          <a class="edit-page" id="edit-page-link" href="#" target="_blank" rel="noopener noreferrer">Edit this page</a>
        </div>
      </div>
      <div class="topbar-actions">
        <div class="search">
          <label for="search" class="visually-hidden">Search pages</label>
          <input id="search" type="text" placeholder="Search pages" aria-label="Search pages" />
        </div>
        <div class="language-switch">
          <label for="language-select" class="visually-hidden">Language</label>
          <span id="language-label">Language</span>
          <select id="language-select" aria-labelledby="language-label">
            <option value="en">English</option>
            <option value="es">Español</option>
          </select>
        </div>
        <a class="header-home" href="../../index.html">Back to homepage</a>
      </div>
    </div>
  </header>
  <div class="wip-banner" id="wip-banner" role="status" aria-live="polite">
    <p id="wip-banner-text"></p>
    <button type="button" id="wip-banner-dismiss">Dismiss</button>
  </div>
  <div class="drawer-overlay" id="drawer-overlay"></div>
  <div id="layout">
    <aside id="nav-drawer">
      <div class="search">
        <label for="search-mobile" class="visually-hidden">Search pages</label>
        <input id="search-mobile" type="text" placeholder="Search pages" aria-label="Search pages" />
      </div>
      <nav id="sidebar"></nav>
    </aside>
    <main>
      <div id="content" class="content">
        <h1>Loading</h1>
        <p>Fetching documentation data.</p>
      </div>
      <div id="giscus-container" aria-label="Comments"></div>
    </main>
    <aside id="toc" class="is-empty">
      <div class="toc-inner">
        <div class="toc-title" id="toc-title">On this page</div>
        <ul class="toc-list" id="toc-list"></ul>
      </div>
    </aside>
  </div>
  <footer class="site-footer">
    <button type="button" id="wip-banner-show">Show WIP notice</button>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
  <script>
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');
    const searchInput = document.getElementById('search');
    const searchInputMobile = document.getElementById('search-mobile');
    const siteTitle = document.getElementById('site-title');
    const pageTitle = document.getElementById('page-title');
    const pageSubtitle = document.getElementById('page-subtitle');
    const homeLink = document.querySelector('.header-home');
    const languageSelect = document.getElementById('language-select');
    const languageLabel = document.getElementById('language-label');
    const toc = document.getElementById('toc');
    const tocTitle = document.getElementById('toc-title');
    const tocList = document.getElementById('toc-list');
    const navToggle = document.getElementById('nav-toggle');
    const drawerOverlay = document.getElementById('drawer-overlay');
    const navDrawer = document.getElementById('nav-drawer');
    const giscusContainer = document.getElementById('giscus-container');
    const wipBanner = document.getElementById('wip-banner');
    const wipBannerText = document.getElementById('wip-banner-text');
    const wipBannerDismiss = document.getElementById('wip-banner-dismiss');
    const wipBannerShow = document.getElementById('wip-banner-show');
    const editPageLink = document.getElementById('edit-page-link');

    const uiCopy = {
      en: {
        pageTitle: 'ALE Psych Engine Cookbook',
        headerTitle: 'ALE Psych Engine Cookbook',
        backHome: 'Back to homepage',
        searchPlaceholder: 'Search pages',
        loadingTitle: 'Loading',
        loadingText: 'Fetching documentation data.',
        docNotFoundTitle: 'Document not found',
        docNotFoundText: 'Please select a page from the sidebar.',
        docLoadErrorTitle: 'Unable to load document',
        docLoadErrorText: 'Please try again later.',
        dataLoadErrorTitle: 'Unable to load cookbook data',
        dataLoadErrorText: 'Please check the data file.',
        languageLabel: 'Language',
        tocTitle: 'On this page',
        relatedHeading: 'Related pages',
        wipText:
          'Work in progress: This Cookbook is still being built. Pages, categories, and content may be added, removed, or modified by the community and developers.',
        wipDismiss: 'Dismiss',
        wipShow: 'Show WIP notice',
        editPage: 'Edit this page',
      },
      es: {
        pageTitle: 'Libro de cocina de ALE Psych Engine',
        headerTitle: 'Libro de cocina de ALE Psych Engine',
        backHome: 'Volver al inicio',
        searchPlaceholder: 'Buscar páginas',
        loadingTitle: 'Cargando',
        loadingText: 'Obteniendo datos de la documentación.',
        docNotFoundTitle: 'Documento no encontrado',
        docNotFoundText: 'Selecciona una página desde la barra lateral.',
        docLoadErrorTitle: 'No se pudo cargar el documento',
        docLoadErrorText: 'Inténtalo de nuevo más tarde.',
        dataLoadErrorTitle: 'No se pudieron cargar los datos del cookbook',
        dataLoadErrorText: 'Revisa el archivo de datos.',
        languageLabel: 'Idioma',
        tocTitle: 'En esta página',
        relatedHeading: 'Páginas relacionadas',
        wipText:
          'Trabajo en progreso: Este Cookbook todavía está en construcción. Las páginas, categorías y el contenido pueden ser añadidos, eliminados o modificados por la comunidad y los desarrolladores.',
        wipDismiss: 'Ocultar aviso',
        wipShow: 'Mostrar aviso de WIP',
        editPage: 'Editar esta página',
      },
    };

    const dataFiles = {
      en: 'en/cookbook-data.json',
      es: 'es/cookbook-data.json',
    };

    let docs = [];
    let linkElements = new Map();
    let activeLanguage = 'en';
    let docsBySlug = new Map();
    let slugByPath = new Map();
    let currentDoc = null;
    let categoryState = {};
    const cookbookRootPath = new URL('.', window.location.href).pathname;
    const categoryStorageKey = 'cookbookCategoryState';
    const wipStorageKey = 'cookbook_wip_notice_dismissed';
    const GITHUB_EDIT_BASE =
      'https://github.com/ALE-Psych-Crew/ale-psych-crew.github.io/edit/main/site/cookbook/';
    const GISCUS_CONFIG = {
      repo: 'ALE-Psych-Crew/ale-psych-crew.github.io',
      repoId: 'R_kgDOQ3BiLQ',
      category: 'Giscus',
      categoryId: 'DIC_kwDOQ3BiLc4C0x6v',
      reactionsEnabled: '1',
      emitMetadata: '0',
      inputPosition: 'bottom',
      theme: 'dark',
    };

    function getUiCopy() {
      return uiCopy[activeLanguage] || uiCopy.en;
    }

    function buildCookbookUrl(slug, lang = activeLanguage) {
      const url = new URL(window.location.href);
      url.searchParams.set('lang', lang);
      url.hash = slug ? `#${slug}` : '';
      return `${url.pathname}${url.search}${url.hash}`;
    }

    function normalizeCookbookPath(pathname) {
      if (!pathname) {
        return '';
      }
      let path = pathname.replace(/\\/g, '/');
      if (path.startsWith(cookbookRootPath)) {
        path = path.slice(cookbookRootPath.length);
      } else if (path.includes('/cookbook/')) {
        path = path.slice(path.lastIndexOf('/cookbook/') + '/cookbook/'.length);
      }
      return path.replace(/^\/+/, '');
    }

    function buildLookupMaps(items) {
      docsBySlug = new Map();
      slugByPath = new Map();
      items.forEach((doc) => {
        docsBySlug.set(doc.slug, doc);
        const normalizedPath = normalizeCookbookPath(doc.path);
        if (normalizedPath) {
          slugByPath.set(normalizedPath, doc.slug);
        }
      });
    }

    function isExternalLink(href) {
      return /^[a-z][a-z0-9+.-]*:/.test(href);
    }

    function normalizeCookbookLink(href) {
      if (!href) {
        return null;
      }
      const trimmed = href.trim();
      if (docsBySlug.has(trimmed)) {
        return trimmed;
      }
      if (trimmed.startsWith('#')) {
        const slug = trimmed.slice(1);
        return docsBySlug.has(slug) ? slug : null;
      }
      if (isExternalLink(trimmed)) {
        return null;
      }
      const baseUrl = currentDoc ? new URL(currentDoc.path, window.location.href) : new URL(window.location.href);
      let resolved;
      try {
        resolved = new URL(trimmed, baseUrl);
      } catch (error) {
        return null;
      }
      const hashSlug = resolved.hash.replace('#', '');
      if (hashSlug && docsBySlug.has(hashSlug)) {
        return hashSlug;
      }
      const normalizedPath = normalizeCookbookPath(resolved.pathname);
      if (normalizedPath && slugByPath.has(normalizedPath)) {
        return slugByPath.get(normalizedPath);
      }
      return null;
    }

    function navigateToSlug(slug, { replace = true } = {}) {
      if (!slug) {
        return;
      }
      const doc = findDocBySlug(slug);
      if (!doc) {
        return;
      }
      const url = buildCookbookUrl(doc.slug, activeLanguage);
      if (replace) {
        history.replaceState(null, '', url);
      } else {
        history.pushState(null, '', url);
      }
      loadDoc(doc);
    }

    function renderMarkdown(markdown) {
      const stripped = markdown.replace(/^---[\s\S]*?---\s*/, '');
      const rendered = marked.parse(stripped);
      const sanitized = DOMPurify.sanitize(rendered, { USE_PROFILES: { html: true } });
      return sanitized || '<p>No content available.</p>';
    }

    function slugify(text) {
      return text
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-');
    }

    function buildTableOfContents(container) {
      tocList.innerHTML = '';
      const ui = getUiCopy();
      const headings = [...container.querySelectorAll('h2, h3')];
      const used = new Set();
      const entries = headings.filter((heading) => {
        const label = heading.textContent.trim();
        return label && label !== ui.relatedHeading;
      });

      entries.forEach((heading) => {
        if (!heading.id) {
          const base = slugify(heading.textContent || 'section');
          let slug = base || 'section';
          let index = 2;
          while (used.has(slug)) {
            slug = `${base}-${index}`;
            index += 1;
          }
          used.add(slug);
          heading.id = slug;
        }
        const item = document.createElement('li');
        item.className = heading.tagName === 'H3' ? 'toc-h3' : 'toc-h2';
        const link = document.createElement('a');
        link.href = '#';
        link.dataset.tocTarget = heading.id;
        link.textContent = heading.textContent;
        item.appendChild(link);
        tocList.appendChild(item);
      });

      if (entries.length) {
        toc.classList.remove('is-empty');
        tocTitle.textContent = ui.tocTitle;
      } else {
        toc.classList.add('is-empty');
      }
    }

    function markRelatedPages(container) {
      const ui = getUiCopy();
      const headings = [...container.querySelectorAll('h2')];
      headings.forEach((heading) => {
        if (heading.textContent.trim() !== ui.relatedHeading) {
          return;
        }
        const wrapper = document.createElement('section');
        wrapper.className = 'related-pages';
        heading.parentNode.insertBefore(wrapper, heading);
        wrapper.appendChild(heading);
        let sibling = wrapper.nextElementSibling;
        while (sibling && sibling.tagName !== 'H2') {
          const next = sibling.nextElementSibling;
          wrapper.appendChild(sibling);
          sibling = next;
        }
      });
    }

    function updateHeaderForDoc(doc) {
      if (!doc) {
        const ui = getUiCopy();
        pageTitle.textContent = ui.docNotFoundTitle;
        pageSubtitle.textContent = '';
        editPageLink.style.display = 'none';
        return;
      }
      pageTitle.textContent = doc.title;
      pageSubtitle.textContent = `${doc.category} > ${doc.title}`;
    }

    function setDrawerOpen(isOpen) {
      document.body.classList.toggle('nav-open', isOpen);
      navToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    }

    function updateWipBanner() {
      const ui = getUiCopy();
      wipBannerText.textContent = ui.wipText;
      wipBannerDismiss.textContent = ui.wipDismiss;
      wipBannerShow.textContent = ui.wipShow;
      const isDismissed = localStorage.getItem(wipStorageKey) === '1';
      wipBanner.style.display = isDismissed ? 'none' : 'flex';
    }

    function buildEditUrl(pagePath) {
      if (!pagePath) {
        return null;
      }
      const normalized = pagePath.replace(/^\/+/, '');
      return `${GITHUB_EDIT_BASE}${normalized}`;
    }

    function updateEditLink(doc) {
      const ui = getUiCopy();
      editPageLink.textContent = ui.editPage;
      if (!doc || !doc.path) {
        editPageLink.style.display = 'none';
        return;
      }
      if (!doc.path.startsWith('en/') && !doc.path.startsWith('es/')) {
        console.warn('Unexpected cookbook doc path for edit link:', doc.path);
      }
      editPageLink.href = buildEditUrl(doc.path);
      editPageLink.style.display = 'inline-flex';
    }

    function buildGiscusTerm(doc) {
      if (!doc) {
        return null;
      }
      return `cookbook-${activeLanguage}-${doc.slug}`;
    }

    function loadGiscusThread(doc) {
      if (!giscusContainer) {
        return;
      }
      giscusContainer.innerHTML = '';
      const term = buildGiscusTerm(doc);
      if (!term) {
        return;
      }
      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.async = true;
      script.crossOrigin = 'anonymous';
      script.setAttribute('data-repo', GISCUS_CONFIG.repo);
      script.setAttribute('data-repo-id', GISCUS_CONFIG.repoId);
      script.setAttribute('data-category', GISCUS_CONFIG.category);
      script.setAttribute('data-category-id', GISCUS_CONFIG.categoryId);
      script.setAttribute('data-mapping', 'specific');
      script.setAttribute('data-term', term);
      script.setAttribute('data-strict', '0');
      script.setAttribute('data-reactions-enabled', GISCUS_CONFIG.reactionsEnabled);
      script.setAttribute('data-emit-metadata', GISCUS_CONFIG.emitMetadata);
      script.setAttribute('data-input-position', GISCUS_CONFIG.inputPosition);
      script.setAttribute('data-theme', GISCUS_CONFIG.theme);
      script.setAttribute('data-lang', activeLanguage);
      giscusContainer.appendChild(script);
    }

    function showWipBanner() {
      localStorage.removeItem(wipStorageKey);
      updateWipBanner();
      wipBanner.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    if (window.marked) {
      marked.setOptions({
        gfm: true,
        breaks: false,
        headerIds: false,
        mangle: false,
        langPrefix: 'language-',
        highlight(code, language) {
          if (window.hljs) {
            if (language && hljs.getLanguage(language)) {
              return hljs.highlight(code, { language }).value;
            }
            return hljs.highlightAuto(code).value;
          }
          return code;
        },
      });
    }

    function setActiveLink(slug) {
      linkElements.forEach((link, key) => {
        link.classList.toggle('active', key === slug);
      });
    }

    function loadDoc(doc) {
      const ui = getUiCopy();
      if (!doc) {
        updateHeaderForDoc(null);
        content.innerHTML = `<h1>${ui.docNotFoundTitle}</h1><p>${ui.docNotFoundText}</p>`;
        loadGiscusThread(null);
        return;
      }
      currentDoc = doc;
      updateHeaderForDoc(doc);
      updateEditLink(doc);
      setActiveLink(doc.slug);
      loadGiscusThread(doc);
      fetch(doc.path)
        .then((res) => res.text())
        .then((text) => {
          content.innerHTML = renderMarkdown(text);
          markRelatedPages(content);
          buildTableOfContents(content);
          warnOnMarkdownLinks(content);
        })
        .catch(() => {
          content.innerHTML = `<h1>${ui.docLoadErrorTitle}</h1><p>${ui.docLoadErrorText}</p>`;
        });
    }

    function buildSidebar(items) {
      sidebar.innerHTML = '';
      linkElements = new Map();
      const categories = new Map();

      items.forEach((item) => {
        if (!categories.has(item.category)) {
          categories.set(item.category, []);
        }
        categories.get(item.category).push(item);
      });

      categories.forEach((docsInCategory, categoryName) => {
        const details = document.createElement('details');
        details.className = 'category';
        details.dataset.category = categoryName;
        details.open = categoryState[categoryName] !== false;
        details.addEventListener('toggle', () => {
          categoryState[categoryName] = details.open;
          localStorage.setItem(categoryStorageKey, JSON.stringify(categoryState));
        });

        const summary = document.createElement('summary');
        summary.textContent = categoryName;
        details.appendChild(summary);

        const list = document.createElement('ul');
        docsInCategory.forEach((doc) => {
          const listItem = document.createElement('li');
          const link = document.createElement('a');
          link.href = buildCookbookUrl(doc.slug, activeLanguage);
          link.textContent = doc.title;
          link.className = 'doc-link';
          link.addEventListener('click', (event) => {
            event.preventDefault();
            navigateToSlug(doc.slug);
            setDrawerOpen(false);
          });
          linkElements.set(doc.slug, link);
          listItem.appendChild(link);
          list.appendChild(listItem);
        });

        details.appendChild(list);
        sidebar.appendChild(details);
      });
    }

    function filterSidebar(query) {
      const normalized = query.trim().toLowerCase();
      const matchingDocs = normalized
        ? docs.filter((doc) => doc.title.toLowerCase().includes(normalized))
        : docs;

      buildSidebar(matchingDocs);

      if (matchingDocs.length) {
        matchingDocs.forEach((doc) => {
          if (doc.slug === location.hash.replace('#', '')) {
            setActiveLink(doc.slug);
          }
        });
      }
    }

    function findDocBySlug(slug) {
      return docsBySlug.get(slug) || docs[0];
    }

    function warnOnMarkdownLinks(container) {
      const markdownLinks = [...container.querySelectorAll('a[href]')]
        .map((link) => link.getAttribute('href'))
        .filter((href) => href && href.includes('.md'));
      if (markdownLinks.length) {
        console.warn('Cookbook markdown links detected:', markdownLinks);
      }
    }

    function setLanguage(lang, { persist = true, updateUrl = true } = {}) {
      if (!dataFiles[lang]) {
        return;
      }
      activeLanguage = lang;
      const ui = getUiCopy();
      document.documentElement.lang = lang;
      document.title = ui.pageTitle;
      siteTitle.textContent = ui.headerTitle;
      homeLink.textContent = ui.backHome;
      searchInput.placeholder = ui.searchPlaceholder;
      searchInput.setAttribute('aria-label', ui.searchPlaceholder);
      searchInputMobile.placeholder = ui.searchPlaceholder;
      searchInputMobile.setAttribute('aria-label', ui.searchPlaceholder);
      languageLabel.textContent = ui.languageLabel;
      languageSelect.value = lang;
      tocTitle.textContent = ui.tocTitle;
      updateHeaderForDoc(currentDoc);
      updateWipBanner();
      updateEditLink(currentDoc);

      if (persist) {
        localStorage.setItem('cookbookLanguage', lang);
      }
      if (updateUrl) {
        const url = new URL(window.location.href);
        url.searchParams.set('lang', lang);
        history.replaceState(null, '', `${url.pathname}${url.search}${url.hash}`);
      }
    }

    function getInitialLanguage() {
      const params = new URLSearchParams(window.location.search);
      const fromQuery = params.get('lang');
      if (fromQuery && dataFiles[fromQuery]) {
        return fromQuery;
      }
      const stored = localStorage.getItem('cookbookLanguage');
      if (stored && dataFiles[stored]) {
        return stored;
      }
      if (navigator.language && navigator.language.toLowerCase().startsWith('es')) {
        return 'es';
      }
      return 'en';
    }

    function loadCookbookData({ keepSlug = true } = {}) {
      const ui = getUiCopy();
      const dataUrl = dataFiles[activeLanguage] || dataFiles.en;
      pageTitle.textContent = ui.loadingTitle;
      pageSubtitle.textContent = ui.loadingText;
      content.innerHTML = `<h1>${ui.loadingTitle}</h1><p>${ui.loadingText}</p>`;
      fetch(dataUrl)
        .then((res) => res.json())
        .then((data) => {
          docs = data;
          buildLookupMaps(docs);
          filterSidebar(searchInput.value);
          const requestedSlug = keepSlug ? location.hash.replace('#', '') : '';
          const initialDoc = findDocBySlug(requestedSlug);
          loadDoc(initialDoc);
        })
        .catch(() => {
          content.innerHTML = `<h1>${ui.dataLoadErrorTitle}</h1><p>${ui.dataLoadErrorText}</p>`;
        });
    }

    activeLanguage = getInitialLanguage();
    try {
      categoryState = JSON.parse(localStorage.getItem(categoryStorageKey) || '{}');
    } catch (error) {
      categoryState = {};
    }
    setLanguage(activeLanguage, { persist: false, updateUrl: true });
    loadCookbookData();

    window.addEventListener('hashchange', () => {
      const slug = location.hash.replace('#', '');
      loadDoc(findDocBySlug(slug));
    });

    function handleSearchInput(value) {
      searchInput.value = value;
      searchInputMobile.value = value;
      filterSidebar(value);
    }

    searchInput.addEventListener('input', (event) => {
      handleSearchInput(event.target.value);
    });

    searchInputMobile.addEventListener('input', (event) => {
      handleSearchInput(event.target.value);
    });

    languageSelect.addEventListener('change', (event) => {
      const nextLang = event.target.value;
      if (nextLang === activeLanguage) {
        return;
      }
      setLanguage(nextLang, { persist: true, updateUrl: true });
      loadCookbookData({ keepSlug: true });
    });

    navToggle.addEventListener('click', () => {
      setDrawerOpen(!document.body.classList.contains('nav-open'));
    });

    drawerOverlay.addEventListener('click', () => {
      setDrawerOpen(false);
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        setDrawerOpen(false);
      }
    });

    wipBannerDismiss.addEventListener('click', () => {
      localStorage.setItem(wipStorageKey, '1');
      updateWipBanner();
    });

    wipBannerShow.addEventListener('click', () => {
      showWipBanner();
    });

    tocList.addEventListener('click', (event) => {
      const link = event.target.closest('a[data-toc-target]');
      if (!link) {
        return;
      }
      event.preventDefault();
      const target = document.getElementById(link.dataset.tocTarget);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    content.addEventListener('click', (event) => {
      const link = event.target.closest('a');
      if (!link) {
        return;
      }
      const href = link.getAttribute('href');
      if (!href || isExternalLink(href)) {
        return;
      }
      if (href.startsWith('#')) {
        const target = content.querySelector(href);
        if (target) {
          event.preventDefault();
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          return;
        }
      }
      const slug = normalizeCookbookLink(href);
      if (!slug) {
        return;
      }
      event.preventDefault();
      navigateToSlug(slug);
    });
  </script>
</body>
</html>
